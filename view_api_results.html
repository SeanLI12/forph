<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Tournament Calendar Viewer</title>
  <style>
    :root {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #1f2933;
      background: #f8fafc;
    }

    body {
      margin: 0 auto;
      padding: 2rem;
      max-width: 1200px;
    }

    h1 {
      margin-bottom: 0.5rem;
      color: #0f172a;
    }

    .description {
      color: #64748b;
      margin-bottom: 1.5rem;
    }

    .controls {
      margin-bottom: 2rem;
      padding: 1.25rem;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .control-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
      align-items: flex-end;
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    .input-group label {
      font-size: 0.85rem;
      font-weight: 700;
      color: #475569;
    }

    input[type="date"] {
      padding: 0.5rem;
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      font-size: 1rem;
      color: #1e293b;
      font-family: inherit;
    }

    button {
      cursor: pointer;
      border-radius: 6px;
      border: none;
      padding: 0.6rem 1.2rem;
      font-size: 1rem;
      font-weight: 500;
      transition: all 0.2s;
    }

    button.primary {
      background: #2563eb;
      color: #fff;
    }

    button.primary:hover {
      background: #1d4ed8;
      box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2);
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.95rem;
      cursor: pointer;
      user-select: none;
    }

    .status-bar {
      margin-bottom: 1rem;
      font-weight: 600;
      padding: 0.75rem;
      border-radius: 6px;
      display: none;
    }

    .status-bar.error {
      display: block;
      background-color: #fee2e2;
      color: #b91c1c;
    }

    .status-bar.success {
      display: block;
      background-color: #dcfce7;
      color: #15803d;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 1.5rem;
    }

    .card {
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      padding: 1.25rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
      display: flex;
      flex-direction: column;
    }

    .card-header {
      border-bottom: 1px solid #f1f5f9;
      padding-bottom: 0.75rem;
      margin-bottom: 0.75rem;
    }

    .card-header h2 {
      margin: 0;
      font-size: 1.25rem;
      color: #334155;
    }

    .meta {
      font-size: 0.875rem;
      color: #64748b;
      margin-top: 0.25rem;
    }

    .tournament-list {
      list-style: none;
      padding: 0;
      margin: 0;
      flex-grow: 1;
    }

    .tournament-item {
      padding: 0.6rem;
      background: #f8fafc;
      border-radius: 6px;
      margin-bottom: 0.5rem;
      font-size: 0.95rem;
      border-left: 3px solid #cbd5e1;
    }

    .tournament-item.active {
      background: #eff6ff;
      border-left-color: #3b82f6;
    }

    .tournament-item.in-range {
      background: #fffbeb;
      border-left-color: #f59e0b;
      border-width: 4px;
    }

    .t-dates {
      font-size: 0.85rem;
      color: #64748b;
      display: block;
      margin-top: 4px;
    }

    .badge {
      display: inline-block;
      padding: 0.15rem 0.5rem;
      border-radius: 99px;
      font-size: 0.7rem;
      text-transform: uppercase;
      font-weight: bold;
      float: right;
    }

    .badge.active {
      background: #dbeafe;
      color: #1e40af;
    }

    .badge.inactive {
      background: #f1f5f9;
      color: #94a3b8;
    }

    .badge.match {
      background: #fef3c7;
      color: #92400e;
      margin-left: 0.5rem;
    }

    .hidden {
      display: none;
    }
  </style>
</head>

<body>
  <h1>üèÜ Tournament Calendar Explorer</h1>
  <p class="description">
    Find tournaments and competitions active on a selected date. (Dates in Taiwan Time)
  </p>

  <div class="controls">
    <div class="control-row">
      <div class="input-group">
        <label for="filterDate">Filter by Date (Taiwan Time)</label>
        <input type="date" id="filterDate" />
      </div>

      <div style="padding-bottom: 0.4rem; display: flex; gap: 1.25rem; align-items: center;">
        <label class="checkbox-label">
          <input type="checkbox" id="onlyActive" checked>
          ‚úÖ Show only active
        </label>

        <label class="checkbox-label" title="Only show tournaments that are running on the selected date">
          <input type="checkbox" id="runningOnDate">
          üìÖ Running on this date
        </label>

        <button id="fetchBtn" class="primary" style="margin-left: 0.5rem;">üîÑ Reload Data</button>
      </div>

      <div id="loading" class="hidden" style="color: #64748b; font-style: italic; padding-bottom: 0.5rem;">Loading...
      </div>
    </div>
  </div>

  <div id="status" class="status-bar"></div>
  <div id="results" class="grid"></div>

  <!-- Load Data Variable -->
  <script src="api_data.js"></script>

  <script>
    // UI Elements
    const fetchBtn = document.getElementById('fetchBtn');
    const resultsEl = document.getElementById('results');
    const statusEl = document.getElementById('status');
    const loadingEl = document.getElementById('loading');
    const filterDateInput = document.getElementById('filterDate');
    const onlyActiveCheckbox = document.getElementById('onlyActive');
    const runningOnDateCheckbox = document.getElementById('runningOnDate');

    let rawData = null;

    // Initialize date picker to today (Taiwan Time)
    function initDatePicker() {
      const now = new Date();
      // Taiwan offset is UTC+8
      const twTime = new Date(now.getTime() + (8 * 60 * 60 * 1000));
      const todayStr = twTime.toISOString().split('T')[0];
      filterDateInput.value = todayStr;
    }
    initDatePicker();

    // Event Listeners
    fetchBtn.addEventListener('click', loadData);
    [onlyActiveCheckbox, runningOnDateCheckbox, filterDateInput].forEach(el => {
      el.addEventListener('change', () => {
        if (rawData) render(rawData);
      });
    });

    function loadData() {
      setLoading(true);
      setStatus('');
      resultsEl.innerHTML = '';

      if (window.TOURNAMENT_DATA) {
        rawData = window.TOURNAMENT_DATA;
        render(rawData);
        setStatus(`Successfully loaded ${rawData.competition?.length || 0} competitions.`, 'success');
        setLoading(false);
      } else {
        setStatus(`Failed to find data. Make sure <code>api_data.js</code> is valid.`, 'error');
        setLoading(false);
      }
    }

    function render(data) {
      resultsEl.innerHTML = '';
      const competitions = data.competition || [];
      const showOnlyActive = onlyActiveCheckbox.checked;
      const filterOnDate = runningOnDateCheckbox.checked;

      // Selected date as UTC midnight for comparison
      const selectedDateStr = filterDateInput.value;
      const selectedTs = selectedDateStr ? new Date(selectedDateStr + 'T00:00:00Z').getTime() : null;

      if (competitions.length === 0) {
        resultsEl.innerHTML = '<p>No competitions found.</p>';
        return;
      }

      let visibleCount = 0;

      competitions.forEach((comp) => {
        const calendar = comp.tournamentCalendar || [];

        // Filter Logic
        let filteredCalendar = calendar.filter(t => {
          // 1. Active status filter
          if (showOnlyActive && String(t.active).toLowerCase() !== 'yes') return false;

          // 2. Date range filter
          if (filterOnDate && selectedTs) {
            const startTs = parseToTs(t.startDate);
            const endTs = parseToTs(t.endDate);

            if (!startTs) return false;

            // If selected date is between start and end
            if (selectedTs >= startTs && (!endTs || selectedTs <= endTs)) {
              return true;
            }
            return false;
          }

          return true;
        });

        if (filteredCalendar.length === 0) return;

        const card = document.createElement('div');
        card.className = 'card';

        // Sort: Active first, then by date
        filteredCalendar.sort((a, b) => {
          const aActive = String(a.active).toLowerCase() === 'yes';
          const bActive = String(b.active).toLowerCase() === 'yes';
          if (aActive !== bActive) return bActive ? 1 : -1;
          return (b.startDate || '').localeCompare(a.startDate || '');
        });

        const listHtml = filteredCalendar.map(t => {
          const isActive = String(t.active).toLowerCase() === 'yes';
          const statusClass = isActive ? 'active' : 'inactive';

          // Check if this specific item matches the date range (for highlighting)
          const startTs = parseToTs(t.startDate);
          const endTs = parseToTs(t.endDate);
          const isMatchingDate = selectedTs && startTs && (selectedTs >= startTs && (!endTs || selectedTs <= endTs));

          const itemClass = `tournament-item ${isActive ? 'active' : ''} ${isMatchingDate ? 'in-range' : ''}`;

          return `
            <li class="${itemClass}">
              <span class="badge ${statusClass}">${isActive ? 'ACTIVE' : 'INACTIVE'}</span>
              ${isMatchingDate ? '<span class="badge match">üìÖ RUNNING</span>' : ''}
              <div class="t-name">${t.name}</div>
              <span class="t-dates">
                ${formatDate(t.startDate)} - ${t.endDate ? formatDate(t.endDate) : '???'}
              </span>
              <div style="font-size: 0.75rem; color: #94a3b8; margin-top:2px;">ID: ${t.id}</div>
            </li>
          `;
        }).join('');

        card.innerHTML = `
          <div class="card-header">
            <h2>${comp.name}</h2>
            <div class="meta">${comp.country} (${comp.competitionFormat})</div>
          </div>
          <ul class="tournament-list">
            ${listHtml}
          </ul>
        `;

        resultsEl.appendChild(card);
        visibleCount++;
      });

      if (visibleCount === 0) {
        resultsEl.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #64748b; padding: 2rem;"><h3>No tournaments match your filters.</h3></div>';
      }
    }

    function parseToTs(isoStr) {
      if (!isoStr) return null;
      let d = new Date(isoStr);
      if (isNaN(d.getTime())) {
        if (/^\d{4}-\d{2}-\d{2}$/.test(isoStr)) {
          d = new Date(`${isoStr}T00:00:00Z`);
        } else {
          return null;
        }
      }
      return d.getTime();
    }

    function formatDate(isoStr) {
      if (!isoStr) return '???';
      let date = new Date(isoStr);
      if (isNaN(date.getTime())) {
        if (/^\d{4}-\d{2}-\d{2}$/.test(isoStr)) {
          date = new Date(`${isoStr}T00:00:00Z`);
        } else {
          return isoStr;
        }
      }

      try {
        return new Intl.DateTimeFormat('zh-TW', {
          timeZone: 'Asia/Taipei',
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          hour12: false
        }).format(date);
      } catch (e) {
        return isoStr.replace('T', ' ').replace('Z', '');
      }
    }

    function setStatus(msg, type = 'normal') {
      statusEl.textContent = '';
      statusEl.innerHTML = msg;
      statusEl.className = 'status-bar';
      if (msg) statusEl.classList.add(type);
    }

    function setLoading(isLoading) {
      if (isLoading) {
        loadingEl.classList.remove('hidden');
        fetchBtn.disabled = true;
      } else {
        loadingEl.classList.add('hidden');
        fetchBtn.disabled = false;
      }
    }

    loadData();
  </script>
</body>

</html>
