<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Tournament Calendar Viewer</title>
  <style>
    :root {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #1f2933;
      background: #f8fafc;
    }

    body {
      margin: 0 auto;
      padding: 2rem;
      max-width: 1200px;
    }

    h1 {
      margin-bottom: 0.5rem;
      color: #0f172a;
    }

    .description {
      color: #64748b;
      margin-bottom: 1.5rem;
    }

    .controls {
      margin-bottom: 2rem;
      padding: 1rem;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    /* Sub-controls inside the panel */
    .control-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem;
      align-items: flex-end;
    }

    .input-group {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }

    .input-group label {
      font-size: 0.85rem;
      font-weight: 700;
      color: #475569;
    }

    input[type="datetime-local"] {
      padding: 0.6rem;
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      font-size: 1rem;
      color: #1e293b;
      font-family: inherit;
    }

    button {
      cursor: pointer;
      border-radius: 6px;
      border: none;
      padding: 0.6rem 1.2rem;
      font-size: 1rem;
      font-weight: 500;
      transition: all 0.2s;
    }

    button.primary {
      background: #2563eb;
      color: #fff;
    }

    button.primary:hover {
      background: #1d4ed8;
      box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2);
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.95rem;
      cursor: pointer;
      user-select: none;
    }

    .status-bar {
      margin-bottom: 1rem;
      font-weight: 600;
      padding: 0.75rem;
      border-radius: 6px;
      display: none;
    }

    .status-bar.error {
      display: block;
      background-color: #fee2e2;
      color: #b91c1c;
    }

    .status-bar.success {
      display: block;
      background-color: #dcfce7;
      color: #15803d;
    }

    /* Grid for Competitions */
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 1.5rem;
    }

    .card {
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      padding: 1.25rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
      display: flex;
      flex-direction: column;
      transition: transform 0.1s ease-in-out;
    }

    .card-header {
      border-bottom: 1px solid #f1f5f9;
      padding-bottom: 0.75rem;
      margin-bottom: 0.75rem;
    }

    .card-header h2 {
      margin: 0;
      font-size: 1.25rem;
      color: #334155;
    }

    .meta {
      font-size: 0.875rem;
      color: #64748b;
      margin-top: 0.25rem;
    }

    .tournament-list {
      list-style: none;
      padding: 0;
      margin: 0;
      flex-grow: 1;
    }

    .tournament-item {
      padding: 0.6rem;
      background: #f8fafc;
      border-radius: 6px;
      margin-bottom: 0.5rem;
      font-size: 0.95rem;
      border-left: 3px solid #cbd5e1;
    }

    .tournament-item.active {
      background: #eff6ff;
      border-left-color: #3b82f6;
    }

    .tournament-item.active .t-name {
      font-weight: 700;
      color: #1e40af;
    }

    .t-dates {
      font-size: 0.85rem;
      color: #64748b;
      display: block;
      margin-top: 4px;
    }

    .badge {
      display: inline-block;
      padding: 0.15rem 0.5rem;
      border-radius: 99px;
      font-size: 0.7rem;
      text-transform: uppercase;
      font-weight: bold;
      float: right;
    }

    .badge.active {
      background: #dbeafe;
      color: #1e40af;
    }

    .badge.inactive {
      background: #f1f5f9;
      color: #94a3b8;
    }

    .hidden {
      display: none;
    }
  </style>
</head>

<body>
  <h1>üèÜ Tournament Calendar Explorer</h1>
  <p class="description">
    Visualizing tournament calendar data from <code>api_results.json</code>.
  </p>

  <div class="controls">
    <div class="control-row">
      <div class="input-group">
        <label for="refDateInput">Reference Time (Taiwan Time)</label>
        <input type="datetime-local" id="refDateInput" />
      </div>

      <div style="padding-bottom: 0.4rem; display: flex; gap: 1.5rem;">
        <label class="checkbox-label" title="Show tournaments starting within 24h from Reference Time">
          <input type="checkbox" id="next24h">
          üïí Starts within 24h
        </label>

        <label class="checkbox-label">
          <input type="checkbox" id="onlyActive" checked>
          ‚úÖ Show only active
        </label>
      </div>

      <button id="fetchBtn" class="primary">üîÑ Reload Data</button>
      <div id="loading" class="hidden" style="color: #64748b; font-style: italic; padding-bottom: 0.5rem;">Loading...
      </div>
    </div>
  </div>

  <div id="status" class="status-bar"></div>
  <div id="results" class="grid"></div>

  <script>
    const DATA_SOURCE = 'api_results.json';

    // UI Elements
    const fetchBtn = document.getElementById('fetchBtn');
    const resultsEl = document.getElementById('results');
    const statusEl = document.getElementById('status');
    const loadingEl = document.getElementById('loading');
    const refDateInput = document.getElementById('refDateInput');
    const onlyActiveCheckbox = document.getElementById('onlyActive');
    const next24hCheckbox = document.getElementById('next24h');

    let rawData = null;

    // Helper: Pad numbers
    const pad = n => n.toString().padStart(2, '0');

    // Initialize Reference Date to Local Time (Assume user context is relevant)
    function initDate() {
      const now = new Date();
      // Format: YYYY-MM-DDThh:mm
      const localIso = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())}T${pad(now.getHours())}:${pad(now.getMinutes())}`;
      refDateInput.value = localIso;
    }
    initDate();

    // Event Listeners
    fetchBtn.addEventListener('click', fetchData);

    // Auto-update render on any filter change
    [onlyActiveCheckbox, next24hCheckbox, refDateInput].forEach(el => {
      el.addEventListener('change', () => {
        if (rawData) render(rawData);
      });
    });

    async function fetchData() {
      setLoading(true);
      setStatus('');
      resultsEl.innerHTML = '';

      try {
        const response = await fetch(DATA_SOURCE);
        if (!response.ok) {
          throw new Error(`HTTP Error: ${response.status} ${response.statusText}`);
        }
        const data = await response.json();
        rawData = data;
        render(data);
        setStatus(`Successfully loaded ${data.competition?.length || 0} competitions from local file.`, 'success');
      } catch (error) {
        console.error(error);
        setStatus(`Failed to load data: ${error.message}. <br>Ensure <code>api_results.json</code> exists in the same directory.`, 'error');
      } finally {
        setLoading(false);
      }
    }

    function render(data) {
      resultsEl.innerHTML = '';
      const competitions = data.competition || [];

      const showOnlyActive = onlyActiveCheckbox.checked;
      const showNext24h = next24hCheckbox.checked;

      // Compute 24h Window
      // Ref Date is taken as-is from input (Local context)
      const refDateVal = new Date(refDateInput.value);
      const windowEnd = new Date(refDateVal.getTime() + 24 * 60 * 60 * 1000); // +24 hours

      if (competitions.length === 0) {
        resultsEl.innerHTML = '<p>No competitions found.</p>';
        return;
      }

      let visibleCount = 0;

      competitions.forEach((comp) => {
        const calendar = comp.tournamentCalendar || [];

        // Filter Logic
        let filteredCalendar = calendar.filter(t => {
          // 1. Check Active Status
          if (showOnlyActive && String(t.active).toLowerCase() !== 'yes') {
            return false;
          }

          // 2. Check 24h Window (if enabled)
          if (showNext24h) {
            const startDateStr = t.startDate;
            if (!startDateStr) return false;

            // Parse startDate.
            // Format usually: "YYYY-MM-DDZ" (UTC midnight) or "YYYY-MM-DD".
            // We treat "Z" dates as UTC.
            let start = new Date(startDateStr);

            // If parsing fails or yields NaN
            if (isNaN(start.getTime())) {
              // Try strictly formatting YYYY-MM-DD to UTC midnight
              if (/^\d{4}-\d{2}-\d{2}$/.test(startDateStr)) {
                start = new Date(`${startDateStr}T00:00:00Z`);
              } else {
                return false; // Unknown format
              }
            }

            // Logic: "Êé®ÁÆó24Â∞èÊôÇÂæåË¶ÅÈñãÊâì" -> Starts within the next 24h window
            // Start Date >= Reference Time AND Start Date <= Window End
            if (start >= refDateVal && start <= windowEnd) {
              return true;
            }
            return false; // Outside window
          }

          return true;
        });

        // Hide Empty Cards
        if (filteredCalendar.length === 0) {
          return;
        }

        // Create Card
        const card = document.createElement('div');
        card.className = 'card';

        // Sort: Active first, then by Start Date
        filteredCalendar.sort((a, b) => {
          if (showNext24h) {
            // If filtering by time, date sort is more important
            return (a.startDate || '').localeCompare(b.startDate || '');
          }
          // Otherwise Active logic
          const aActive = String(a.active).toLowerCase() === 'yes';
          const bActive = String(b.active).toLowerCase() === 'yes';
          if (aActive !== bActive) return bActive ? 1 : -1;
          return (b.startDate || '').localeCompare(a.startDate || '');
        });

        const listHtml = filteredCalendar.map(t => {
          const isActive = String(t.active).toLowerCase() === 'yes';
          const statusClass = isActive ? 'active' : 'inactive';
          const itemClass = isActive ? 'tournament-item active' : 'tournament-item';

          return `
            <li class="${itemClass}">
              <span class="badge ${statusClass}">${isActive ? 'ACTIVE' : 'INACTIVE'}</span>
              <div class="t-name">${t.name}</div>
              <span class="t-dates">${formatDate(t.startDate)} - ${formatDate(t.endDate)}</span>
              <div style="font-size: 0.75rem; color: #94a3b8; margin-top:2px;">ID: ${t.id}</div>
            </li>
          `;
        }).join('');

        card.innerHTML = `
          <div class="card-header">
            <h2>${comp.name}</h2>
            <div class="meta">${comp.country} (${comp.competitionFormat})</div>
          </div>
          <ul class="tournament-list">
            ${listHtml}
          </ul>
        `;

        resultsEl.appendChild(card);
        visibleCount++;
      });

      if (visibleCount === 0) {
        resultsEl.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #64748b; padding: 2rem;"><h3>No tournaments match your filters.</h3><p>Try unchecking "Start in next 24h" or adjusting the Reference Time.</p></div>';
      }
    }

    function formatDate(isoStr) {
      if (!isoStr) return '???';
      // Just show the YYYY-MM-DD part
      return isoStr.split('T')[0].replace('Z', '');
    }

    function setStatus(msg, type = 'normal') {
      statusEl.textContent = '';
      statusEl.innerHTML = msg;
      statusEl.className = 'status-bar';
      if (msg) statusEl.classList.add(type);
    }

    function setLoading(isLoading) {
      if (isLoading) {
        loadingEl.classList.remove('hidden');
        fetchBtn.disabled = true;
      } else {
        loadingEl.classList.add('hidden');
        fetchBtn.disabled = false;
      }
    }

    // Initial fetch
    fetchData();
  </script>
</body>

</html>
